<template>
  <div class="table-responsive">
    <div ref="filterContainer"></div>
    <table class="table table-bordered" width="100%" cellspacing="0">
      <tr>
        <th v-for="header in headers" v-bind:key="header.dataField"
          v-on:click="sortByExpression(header.dataField)" v-bind:class="header.titleClass">
          {{header.title}}
          <span v-if="currentSortCriteria === header.dataField" class="fas" :class="{'fa-sort-amount-down': currentSortCriteria === header.dataField && currentSortDesc === true,
          'fa-sort-amount-up': currentSortCriteria === header.dataField && currentSortDesc === false}"></span>
        </th>
      </tr>
      <tr v-for="row in getPaginatedData()" v-bind:key="row[0]" v-on:click="clickOn(row['Key'])">
        <template v-for="column in headers">
          <td v-bind:key="column.dataField" v-bind:class="column.rowClass">{{formatRow(row[column.dataField], column.formatter)}}</td>
        </template>
      </tr>
    </table>
    <pagination></pagination>
  </div>
</template>

<script>
import pagination from './pagination'
import filterBar from './filterBar'
import workFilterBar from '../../PageElements/WorkFilterBar'
import moment from 'moment'
import _ from 'lodash'
import Vue from 'Vue'

const pageSize = 10

export default {
  name: 'myTable',
  components: {
    pagination,
    filterBar
  },
  data () {
    return {
      rawDataset: [],
      filteredDataset: '',
      pageSize: pageSize,
      currentPage: 1,
      currentSortCriteria: '',
      currentSortDesc: '',
      currentSeachCriteria: '',
      moneyFormatter: new Intl.NumberFormat('es-ES', {
        style: 'currency',
        currency: 'EUR'
      })
    }
  },
  props: {
    headers: {
      type: Array,
      required: true
    },
    searchFields: {
      type: Array,
      required: true
    },
    eventId: {
      type: String,
      required: true
    },
    filterType: {
      type: String,
      required: false
    },
    filterName: {
      type: String,
      required: false
    },
    urlBase: {
      type: String,
      required: true
    }
  },
  methods: {
    formatRow(row, formatter) {
      if(formatter === 'date' && row !== null && row !== undefined) {
        return moment(row).format('DD/MM/YYYY')
      } else if(formatter === 'money' && row !== null && row !== undefined) {
        return this.moneyFormatter.format(row)
      } else {
      return row
      }
    },
    setDataset: function (dataset) {
      this.rawDataset = dataset
      //Let's check if the dataset contains the required Key column
      if (_.some(dataset, ['Key', undefined])) {
        throw 'Missing Key column in passed dataset in MyTable.vue'
      }

      this.applyTextFilter('') // Just to load all the data
    },
    clickOn: function(index) {
      // This method must pass the state of the table to the destination component just for the "Back" functionality
      // this.$root.$emit('table:click:' + this.eventId, {
      //   index: index,
      //   filter: this.currentSeachCriteria,
      //   sortCriteria: this.currentSortCriteria,
      //   sortDirection: this.currentSortDesc,
      //   currentPage: this.currentPage,
      //   component: this.eventId,
      //   filteredDataset: this.filteredDataset
      //   })
      this.$router.push({
        path: this.urlBase + index
      })
    },
    // Pagination
    loadPage: function (page) {
      this.currentPage = page
    },
    getPaginatedData: function () {
      if (this.rawDataset.length === 0){
        return []
      }
      var arraySize = this.rawDataset.length - 1
      var left = (this.currentPage - 1) * this.pageSize
      var right = (this.currentPage * this.pageSize)
      if (right > arraySize) {
        right = arraySize + 1
      }

      if (left < 0 || left > arraySize)
        return []
      else {
        return _.slice(this.filteredDataset, left, right)
      }
    },
    // Sorting
    sortByExpression: function(expression) {
      if (expression === this.currentSortCriteria) {
        this.currentSortDesc = !this.currentSortDesc
      } else {
        this.currentSortCriteria = expression
        this.currentSortDesc = true
      }
      this.sortBy()
    },
    sortBy: function() {
      var x = this.currentSortCriteria
      this.filteredDataset = _.sortBy(this.filteredDataset, function(row) {
        return row[x]
        })
      if (!this.currentSortDesc) {
        this.filteredDataset = _.reverse(this.filteredDataset)
      }
    },
    // Filter
    applyTextFilter: function (searchCriteria) {
      if (searchCriteria !== '' && this.searchFields.length > 0) {
        this.currentSeachCriteria = searchCriteria
        var lowercaseFilter = searchCriteria.toString().toLowerCase()
        this.filteredDataset = []

        for (var i=0; i != this.searchFields.length; i++){
          var currentSearchField = this.searchFields[i]
          var subset = _.filter(this.rawDataset, function(row){
            if (row[currentSearchField] === null) return false
            return row[currentSearchField].toString().toLowerCase().includes(lowercaseFilter)
          })
          this.filteredDataset = _.union(this.filteredDataset, subset, function(row) {
            return row.IdTrabajo})
        }
        this.sortBy()
      } else {
        this.filteredDataset = this.rawDataset
      }
      this.currentPage = 1
      this.logInfo()
    },
    restoreState: function(data){
      this.filteredDataset = data.filteredDataset
      this.currentSortCriteria = data.sortCriteria
      this.currentSortDesc = data.sortDirection
      this.currentPage = data.currentPage
      this.logInfo()
    },
    logInfo: function() {
      // console.log('this.rawDataset: ' +this.rawDataset.length)
      // console.log('this.filteredDataset: ' + this.filteredDataset.length)
      // console.log('this.currentSeachCriteria: ' + this.currentSeachCriteria)
      // console.log('this.currentPage: ' + this.currentPage)
      // console.log('this.currentSortCriteria: ' + this.currentSortCriteria)
      // console.log('this.currentSortDesc: ' + this.currentSortDesc)
      // console.log('this.currentPage: ' + this.currentPage)
    }
  },
  mounted () {
    // Check the required parameters (props)
    if (this.headers === undefined || this.headers === null)
      throw 'Missing prop headers in myTable.vue'
    if (this.searchFields === undefined || this.searchFields === null)
      throw 'Missing prop searchFields in myTable.vue'
    if (this.eventId === undefined || this.eventId === null)
      throw 'Missing prop eventId in myTable.vue'
    if (this.urlBase === undefined || this.urlBase === null)
      throw 'Missing prop urlBase in myTable.vue'

    this.currentSortCriteria = this.searchFields[0]
    this.currentSortDesc = true
    moment.locale('es')

    this.$root.$on('table:setState:' + this.eventId, this.restoreState)

    // Loading the filter component based ion configuration
    var ComponentClass, instance
    if (this.filterType === 'WorkFilterBar'){
      ComponentClass = Vue.extend(workFilterBar)
      instance = new ComponentClass({
        propsData: {
          filterName: this.filterName
        }
      })
    } else {
      ComponentClass = Vue.extend(filterBar)
      instance = new ComponentClass()
    }
    instance.$parent = this
    instance.$root = this.$root
    instance.$mount()
    this.$refs.filterContainer.appendChild(instance.$el)
  }
}
</script>
<style>
.invisible {
  display: none;
}
</style>
